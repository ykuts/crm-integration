// Prisma Schema for CRM Integration Database
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("CRM_DATABASE_URL")
}

// Bot Orders Table - stores orders from chat bots
model BotOrder {
  id         Int      @id @default(autoincrement())
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Bot order identification
  botOrderId String @unique @map("bot_order_id")
  source       String
  chatId      String @map("chat_id")

  // Customer information
  customerPhone String @map("customer_phone")
  customerName  String @map("customer_name")
  customerEmail String? @map("customer_email")

  // Order details
  products      String // JSON string of products array
  deliveryInfo  String @map("delivery_info") // JSON string of delivery information
  paymentMethod String @map("payment_method")
  totalAmount   Float @map("total_amount")

  // Order status and tracking
  status String @default("PENDING")
  notes  String?

  // SendPulse integration
  sendpulseDealId   String?   @map("sendpulse_deal_id")
  sendpulseContactId String?  @map("sendpulse_contact_id")

  // Additional metadata
  metadata String @default("{}")

  @@map("bot_orders")
  @@index([botOrderId])
  @@index([source])
  @@index([customerPhone])
  @@index([status])
  @@index([createdAt])
}

// Product Mapping Table - maps ecommerce products to SendPulse products
model ProductMapping {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Mapping information
  ecommerceId  Int    @unique @map("ecommerce_id")
  sendpulseId  Int    @map("sendpulse_id")
  name         String
  
  // Optional sync information
  lastSyncAt  DateTime? @map("last_sync_at")
  syncStatus  String @default("ACTIVE") @map("sync_status")

  @@map("product_mappings")
  @@index([ecommerceId])
  @@index([sendpulseId])
}

// Customer Mapping Table - maps ecommerce customers to SendPulse contacts
model CustomerMapping {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Customer identification
  ecommerceId    Int?    @map("ecommerce_id")
  phone          String  @unique
  email          String?
  
  // SendPulse information
  sendpulseId    String  @map("sendpulse_id")
  firstName      String @map("first_name")
  lastName       String @map("last_name")

  // Sync information
  lastSyncAt     DateTime? @map("last_sync_at")
  syncStatus     String @default("ACTIVE") @map("sync_status")

  @@map("customer_mappings")
  @@index([phone])
  @@index([email])
  @@index([sendpulseId])
}

// Sync Jobs Table - tracks synchronization jobs
model SyncJob {
  id          Int      @id @default(autoincrement())
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  startedAt  DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Job information
  jobType     String   @map("job_type")
  status      String   @default("PENDING")
  
  // Results
  itemsProcessed Int @default(0) @map("items_processed")
  itemsSuccess   Int @default(0) @map("items_success")
  itemsError     Int @default(0) @map("items_error")

  // Error information
  errorMessage String? @map("error_message")
  errorDetails String? @map("error_details")

  // Configuration
  config       String @default("{}")

  @@map("sync_jobs")
  @@index([jobType])
  @@index([status])
  @@index([createdAt])
}

// Webhook Events Table - logs incoming webhooks
model WebhookEvent {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now()) @map("created_at")

  // Webhook information
  source     String
  eventType  String   @map("event_type")
  eventId    String?  @map("event_id")
  
  // Request details
  headers   String
  payload   String
  
  // Processing status
  processed    Boolean @default(false)
  processedAt  DateTime? @map("processed_at")
  errorMessage String? @map("error_message")

  @@map("webhook_events")
  @@index([source])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
}

// API Logs Table - logs important API calls for debugging
model ApiLog {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now()) @map("created_at")

  // Request information
  method      String
  endpoint    String
  statusCode  Int @map("status_code")
  
  // User information
  userType    String?  @map("user_type")
  userId      String?  @map("user_id")
  userAgent   String?  @map("user_agent")
  ipAddress   String?  @map("ip_address")

  // Timing
  responseTime Int? @map("response_time")

  // Additional context
  context       String @default("{}")
  errorMessage  String? @map("error_message")

  @@map("api_logs")
  @@index([endpoint])
  @@index([statusCode])
  @@index([userType])
  @@index([createdAt])
}